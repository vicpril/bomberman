name: DEPLOY

on:
  push:
    branches: [ "master" ]

jobs:

  build:

    runs-on: ubuntu-latest
    env:
        VERSION: latest

    steps:
    
    - name: Check Out Repo 
      uses: actions/checkout@v2

    # - name: Pull images
    #   uses: appleboy/ssh-action@v1.0.3
    #   with:
    #     host: ${{ secrets.HOST }}
    #     username: ${{ secrets.SSH_USER }}
    #     key: ${{ secrets.SSH_KEY }}
    #     script: |
    #       docker pull ghcr.io/vicpril/bomberman-sockets:latest
    #       docker pull ghcr.io/vicpril/bomberman-frontend:latest
    #       docker pull ghcr.io/vicpril/bomberman-api:latest
    #       docker pull ghcr.io/vicpril/bomberman-json:latest
    #       docker pull ghcr.io/vicpril/bomberman-nginx:latest
    #       docker image list

    - name: 'Refresh .env: copy template to remote'
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        source: ".env.production,.deploy/docker-compose.yml"
        target: /home/${{ secrets.SSH_USER }}
        overwrite: true
        strip_components: 1
        
    - name: 'Refresh .env: edit .env with secrets'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /home/${{ secrets.SSH_USER }}/
          rm -f .env
          mv .env.production .env
          printf "\nPOSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
          printf "\nPGADMIN_DEFAULT_PASSWORD=${{ secrets.PGADMIN_DEFAULT_PASSWORD }}" >> .env

    - name: Reload remote components
      uses: appleboy/ssh-action@v1.0.3
      with: 
        host: ${{ secrets.HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /home/${{ secrets.SSH_USER }}/
          docker-compose down
          docker-compose up -d --build --force-recreate


