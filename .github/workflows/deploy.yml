name: DEPLOY

on:
  push:
    branches: [ "master" ]

jobs:

  build:

    runs-on: ubuntu-latest
    env:
        VERSION: latest

    steps:
    
    - name: Check Out Repo 
      uses: actions/checkout@v2

    # - name: Pull images
    #   uses: appleboy/ssh-action@v1.0.3
    #   with:
    #     host: ${{ secrets.HOST }}
    #     username: ${{ secrets.SSH_USER }}
    #     key: ${{ secrets.SSH_KEY }}
    #     script: |
    #       docker pull ghcr.io/vicpril/bomberman-sockets:latest
    #       docker pull ghcr.io/vicpril/bomberman-frontend:latest
    #       docker pull ghcr.io/vicpril/bomberman-api:latest
    #       docker pull ghcr.io/vicpril/bomberman-json:latest
    #       docker pull ghcr.io/vicpril/bomberman-nginx:latest
    #       docker image list

    # - name: 'Refresh .env: remove old file'
    #   uses: appleboy/ssh-action@v1.0.3
    #   with:
    #     host: ${{ secrets.HOST }}
    #     username: ${{ secrets.SSH_USER }}
    #     key: ${{ secrets.SSH_KEY }}
    #     script: |
    #       rm -f .env /home/${{ secrets.SSH_USER }}/.env

    - name: 'Refresh .env: copy template to remote'
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        source: ".env.production,.deploy/docker-compose.yml"
        target: /home/${{ secrets.SSH_USER }}
        overwrite: true
        
    - name: 'Refresh .env: edit .env with secrets'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /home/${{ secrets.SSH_USER }}/
          rm -f .env
          mv .env.production .env
          printf "\nPOSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
          printf "\nPGADMIN_DEFAULT_PASSWORD=${{ secrets.PGADMIN_DEFAULT_PASSWORD }}" >> .env
          cat .env

    - name: Reload remote components
      uses: appleboy/ssh-action@v1.0.3
      with: 
        host: ${{ secrets.HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: |
            cd cd /home/${{ secrets.SSH_USER }}/
            docker-compose down
            docker-compose up -d --build --force-recreate

      
    
    # - name: 'Create env file'
    #   uses: appleboy/ssh-action@v1.0.3
    #   with:
    #     host: ${{ secrets.HOST }}
    #     username: ${{ secrets.SSH_USER }}
    #     key: ${{ secrets.SSH_KEY }}
    #     script: |
    #       cd /home/${{ secrets.SSH_USER }}/
    #       rm -f .env
    #       touch .env
    #       echo CLIENT_URL=${{ vars.CLIENT_URL }} >> .env
    #       echo API_URL=${{ vars.API_URL }} >> .env
    #       echo API_JSON_URL=${{ vars.API_JSON_URL }} >> .env
    #       echo DATABASE_URL=${{ vars.DATABASE_URL }} >> .env
    #       echo POSTGRES_USER=${{ vars.POSTGRES_USER }} >> .env
    #       echo POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }} >> .env
    #       echo POSTGRES_DB=${{ vars.POSTGRES_DB }} >> .env
    #       echo POSTGRES_HOST=${{ vars.POSTGRES_HOST }} >> .env
    #       echo POSTGRES_PORT=${{ vars.POSTGRES_PORT }} >> .env
    #       echo PGADMIN_DEFAULT_EMAIL=${{ vars.PGADMIN_DEFAULT_EMAIL }} >> .env
    #       echo PGADMIN_DEFAULT_PASSWORD=${{ secrets.PGADMIN_DEFAULT_PASSWORD }} >> .env
    #       echo CLIENT_URL=${{ vars.CLIENT_URL }} >> .env
    #       echo API_URL=${{ vars.API_URL }} >> .env
    #       echo API_JSON_URL=${{ vars.API_JSON_URL }} >> .env
    #       echo SOCKETS_URL=${{ vars.SOCKETS_URL }} >> .env
    #       echo SOCKETS_PATH=${{ vars.SOCKETS_PATH }} >> .env
    #       cat .env
    
    # - name: Reload remote components
    #   uses: appleboy/ssh-action@v1.0.3
    #   env:
    #     INPUT_CLIENT_URL: ${{ vars.CLIENT_URL }}
    #   with:
    #     host: ${{ secrets.HOST }}
    #     username: ${{ secrets.SSH_USER }}
    #     key: ${{ secrets.SSH_KEY }}
    #     allenvs: true
    #     script: |
    #       echo "I am $INPUT_CLIENT_URL"
