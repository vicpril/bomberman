(()=>{"use strict";var t={n:e=>{var s=e&&e.__esModule?()=>e.default:()=>e;return t.d(s,{a:s}),s},d:(e,s)=>{for(var i in s)t.o(s,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:s[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{createServerIo:()=>w,io:()=>G,startServer:()=>Y});const s=[["W","W","W","W","W","W","W","W","W","W","W","W","W","W","W"],["W","x","x","x"," "," "," "," "," "," "," "," ","x","x","W"],["W","x","W"," ","W"," ","W"," ","W"," ","W"," ","W","x","W"],["W"," "," "," "," "," "," "," "," "," "," "," "," ","x","W"],["W"," ","W"," ","W"," ","W"," ","W"," ","W"," ","W"," ","W"],["W"," "," "," "," "," "," "," "," "," "," "," "," "," ","W"],["W"," ","W"," ","W"," ","W"," ","W"," ","W"," ","W"," ","W"],["W","x"," "," "," "," "," "," "," "," "," "," "," "," ","W"],["W","x","W"," ","W"," ","W"," ","W"," ","W"," ","W","x","W"],["W","x","x"," "," "," "," "," "," "," "," ","x","x","x","W"],["W","W","W","W","W","W","W","W","W","W","W","W","W","W","W"]],i=64,o=11,r=15,n=(Math.PI,{x:1,y:1}),l={x:13,y:1};var a,h,c;!function(t){t[t.players=0]="players",t[t.soft_walls=1]="soft_walls",t[t.bombs=2]="bombs",t[t.explosions=3]="explosions",t[t.position=4]="position",t[t.coords=5]="coords",t[t.frame_type=6]="frame_type",t[t.direction=7]="direction",t[t.movement=8]="movement",t[t.player_bombs=9]="player_bombs",t[t.player_score=10]="player_score",t[t.timer=11]="timer",t[t.alive=12]="alive",t[t.index=13]="index"}(a||(a={}));class d{constructor(t){this.value=t,this.listeners=[]}get(){return this.value}set(t){this.value!==t&&(this.value=t,this.listeners.forEach((e=>e(t))))}subscribe(t){return this.listeners.push(t),()=>{this.listeners=this.listeners.filter((e=>e!==t))}}}!function(t){t.WALL="W",t.WALL_SOFT="s",t.BOMB="B",t.EMPTY=" ",t.EMPTY_REQUIRED="x",t.EXPLOSION="X",t.PLAYER="p"}(h||(h={})),function(t){t[t.NONE=1]="NONE",t[t.UP=2]="UP",t[t.RIGHT=3]="RIGHT",t[t.DOWN=4]="DOWN",t[t.LEFT=5]="LEFT"}(c||(c={}));const p={[c.NONE]:{x:0,y:0},[c.UP]:{x:0,y:-1},[c.RIGHT]:{x:1,y:0},[c.DOWN]:{x:0,y:1},[c.LEFT]:{x:-1,y:0}};var y,E,u,m;!function(t){t[t.PERMANENT=1]="PERMANENT",t[t.UP=2]="UP",t[t.RIGHT=3]="RIGHT",t[t.DOWN=4]="DOWN",t[t.LEFT=5]="LEFT",t[t.BLOW=6]="BLOW",t[t.DEFEAT=7]="DEFEAT",t[t.VICTORY=8]="VICTORY"}(y||(y={})),function(t){t[t.BOMB=1]="BOMB",t[t.PLAYER=2]="PLAYER",t[t.EXPLOSION_CENTER=3]="EXPLOSION_CENTER",t[t.EXPLOSION_MIDDLE=4]="EXPLOSION_MIDDLE",t[t.EXPLOSION_END=5]="EXPLOSION_END"}(E||(E={})),E.BOMB,y.PERMANENT,E.PLAYER,y.UP,y.RIGHT,y.DOWN,y.LEFT,y.BLOW,E.EXPLOSION_CENTER,y.PERMANENT,E.EXPLOSION_MIDDLE,y.UP,y.RIGHT,y.DOWN,y.LEFT,E.EXPLOSION_END,y.UP,y.RIGHT,y.DOWN,y.LEFT;class P{constructor(t){this.alive=!0,this.BF=t.BF,this.pos=t.pos}}class v extends P{constructor({pos:t,BF:e,frameDirection:s,isCenter:i,isEnd:o}){super({pos:t,BF:e}),this.type=h.EXPLOSION,this.timer=300,this.frameDirection=i?y.PERMANENT:s,this.frameType=i?E.EXPLOSION_CENTER:o?E.EXPLOSION_END:E.EXPLOSION_MIDDLE,this.BF.explosions[`${t.x}:${t.y}`]=this.getExportData(),this.alive=!0,this.init()}init(){setTimeout((()=>{this.alive=!1,delete this.BF.explosions[`${this.pos.x}:${this.pos.y}`],this.BF.removeEntityFromPosition(this.type,this.pos)}),this.timer)}getExportData(){return{[a.position]:[this.pos.x,this.pos.y],[a.direction]:this.frameDirection,[a.frame_type]:this.frameType}}}class x extends P{constructor({pos:t,owner:e,blownSize:s,BF:i}){super({BF:i,pos:t}),this.type=h.BOMB,this.radius=25.6,this.alive=!0,this.timer=3e3,this.owner=e,this.blownSize=s,this.init(),this.BF.bombs[`${t.x}:${t.y}`]=[t.x,t.y]}init(){setTimeout((()=>{this.blowUp()}),this.timer)}blowUp(){this.alive&&(this.alive=!1,this.BF.removeEntityFromPosition(this.type,this.pos),this.owner.addBombToPlayer(),this.owner.pos.x===this.pos.x&&this.owner.pos.y===this.pos.y&&this.owner.die(),this.BF.clearCell(this.pos),delete this.BF.bombs[`${this.pos.x}:${this.pos.y}`],Object.values(p).forEach((t=>{var e,s,i;for(let o=0;o<this.blownSize;o++){const r={x:this.pos.x+t.x*o,y:this.pos.y+t.y*o},n=this.BF.getCell(r);if(n===h.WALL)return;if(n===h.WALL_SOFT&&this.BF.destroyWall(r),n===h.BOMB)return void(null===(e=this.BF.findEntity(h.BOMB,r))||void 0===e||e.blowUp());const l=0===o,a=o===this.blownSize-1;let d;switch(0===(i=t).x&&-1===i.y?c.UP:1===i.x&&0===i.y?c.RIGHT:0===i.x&&1===i.y?c.DOWN:-1===i.x&&0===i.y?c.LEFT:c.NONE){default:case c.UP:d=y.UP;break;case c.RIGHT:d=y.RIGHT;break;case c.DOWN:d=y.DOWN;break;case c.LEFT:d=y.LEFT}switch(this.BF.addEntity(new v({pos:r,BF:this.BF,frameDirection:d,isCenter:l,isEnd:a})),this.BF.clearCell(r),n){case h.WALL_SOFT:return void this.owner.increaseScore();case h.PLAYER:return void(null===(s=this.BF.findEntity(h.PLAYER,r))||void 0===s||s.die())}}})))}}function W(t){return t.x>0&&t.x<r-1&&t.y>0&&t.y<o-1}class f extends P{constructor({speed:t,BF:e,pos:s}){super({BF:e,pos:s}),this.isStoping=!1,this.nextPos=null,this.direction=c.NONE,this.speed=t,this.intervalID=setInterval((()=>{this.refresh(20)}),20)}getNextPos(t){return{x:this.pos.x+p[t].x,y:this.pos.y+p[t].y}}destroy(){clearInterval(this.intervalID)}moveOn(t){if(t!==c.NONE){if(this.direction===c.NONE){if(!this.isMovingAvailable(t))return;this.isStoping=!1,this.direction=t}}else this.moveOff()}moveOff(){this.isStoping=!0}refresh(t){var e;if(this.direction!==c.NONE){if(this.nextPos=null!==(e=this.nextPos)&&void 0!==e?e:this.getNextPos(this.direction),!W(this.nextPos))return this.moveOff(),void this.replacePosition();switch(this.direction){case c.UP:case c.DOWN:this.coords.y=this.calculateCoords("y",t);break;case c.RIGHT:case c.LEFT:this.coords.x=this.calculateCoords("x",t)}(Math.abs(this.coords.x-(this.pos.x+.5)*i)>i||Math.abs(this.coords.y-(this.pos.y+.5)*i)>i)&&this.replacePosition()}}calculateCoords(t,e){if(this.nextPos){const s=(this.nextPos[t]-this.pos[t])*i/this.speed*e,n=this.coords[t]+s;return"x"===t&&(n+32>r*i||n-32<0)||"y"===t&&(n+32>o*i||n-32<0)?this.coords[t]:n}return this.coords[t]}replacePosition(){this.nextPos&&W(this.nextPos)&&(this.BF.getCell(this.pos)===this.type&&this.BF.clearCell(this.pos),this.pos=this.nextPos,this.BF.setCell(this.pos,this.type),this.nextPos=null,this.isMovingAvailable(this.direction)||(this.direction=c.NONE)),this.isStoping&&(this.direction=c.NONE,this.isStoping=!1,this.coords={x:(this.pos.x+.5)*i,y:(this.pos.y+.5)*i},this.nextPos=null)}}class O extends f{constructor({id:t,BF:e,pos:s}){super({BF:e,pos:s,speed:300}),this.type=h.PLAYER,this.alive=!0,this.hasBombs=2,this.score=0,this.bombBlownSize=3,this.isMovingAvailable=t=>{const e=this.getNextPos(t);return this.BF.isCellEmpty(e)},this.id=t,this.coords={x:(s.x+.5)*i,y:(s.y+.5)*i}}addBombToPlayer(){this.hasBombs+=1}removeBombFromPlayer(){this.hasBombs-=1}get bombs(){return this.BF.findBombs(this)}getExportData(){return{[a.coords]:[this.coords.x,this.coords.y],[a.movement]:this.direction,[a.player_bombs]:this.hasBombs,[a.player_score]:this.score,[a.alive]:this.alive?1:0}}increaseScore(t=1){this.score+=t}placeBomb(){if(!(this.hasBombs<=0)&&this.BF.getCell(this.pos)===h.PLAYER){const t=new x({pos:this.pos,owner:this,blownSize:this.bombBlownSize,BF:this.BF});this.BF.addEntity(t),this.BF.setCell(this.pos,h.BOMB),this.removeBombFromPlayer()}}die(){this.alive=!1,this.BF.gameOver()}}class T{constructor(t){this.game=t,this.isInitialized=!1,this.cells=[],this.entities=[],this.players=new Map,this.softWalls={},this.bombs={},this.explosions={},this.generateLevel(),this.isInitialized=!0}generateLevel(){const t=[];s.forEach(((e,s)=>{t[s]=[],e.forEach(((e,i)=>{switch(e){case h.EMPTY:Math.random()<.5&&(t[s][i]=h.WALL_SOFT,this.softWalls[`${i}:${s}`]=[s,i]);break;case h.EMPTY_REQUIRED:t[s][i]=h.EMPTY;break;case h.WALL:t[s][i]=h.WALL;break;default:t[s][i]=h.EMPTY}}))})),this.cells=t}getCell(t){return this.isInitialized?this.cells[t.y][t.x]:h.EMPTY}setCell(t,e){this.isInitialized&&(this.cells[t.y][t.x]=e)}destroyWall({x:t,y:e}){delete this.softWalls[`${t}:${e}`],this.clearCell({x:t,y:e})}exportCells(){return this.cells}exportSoftWalls(){return Object.values(this.softWalls)}exportBombs(){return Object.values(this.bombs)}exportExplosions(){return Object.values(this.explosions)}isCellEmpty(t){if(!this.isInitialized)return!1;const e=this.getCell(t);return void 0===e||e===h.EMPTY}clearCell(t){this.isInitialized&&this.setCell(t,h.EMPTY)}getEntities(){return this.entities}addEntity(t){this.setCell(t.pos,t.type),this.entities.push(t),t instanceof O&&this.players.set(t.id,t)}findEntity(t,e){var s;return null!==(s=this.entities.find((s=>s.type===t&&s.pos.x===e.x&&s.pos.y===e.y)))&&void 0!==s?s:null}findAnyEntity(t,e){var s;return null!==(s=this.entities.find((s=>s.type===t&&s.pos.x===e.x&&s.pos.y===e.y)))&&void 0!==s?s:null}removeEntityFromPosition(t,e){const s=this.findAnyEntity(t,e);return!!s&&(this.entities=this.entities.filter((t=>t!==s)),!0)}findBombs(t){const e=this.entities.filter((t=>t.type===h.BOMB));return t?e.filter((e=>e.owner===t)):e}findPlayers(){return[...this.players.values()]}findPlayerById(t){var e;return null!==(e=this.players.get(t))&&void 0!==e?e:null}removePlayer(t){const e=this.findPlayerById(t);e&&(this.clearCell(e.pos),this.players.delete(t))}clearEntities(){this.entities=this.entities.filter((t=>t.alive))}gameOver(){this.game.stopGame()}destroy(){this.cells=[],this.entities=[],this.isInitialized=!1}}!function(t){t.NOT_STARTED="NOT_STARTED",t.SHOW_STAGE="SHOW_STAGE",t.IN_PROGRESS="IN_PROGRESS",t.STAGE_COMPLETED="STAGE_COMPLETED",t.FINISHED="FINISHED",t.WAITING_PLAYER="WAITING_PLAYER"}(u||(u={})),function(t){t.SINGLE_PLAYER="SINGLE_PLAYER",t.MULTI_PLAYER="MULTI_PLAYER"}(m||(m={}));class B{constructor(){this.mode=new d(m.MULTI_PLAYER),this.status=new d(u.NOT_STARTED),this.stage=new d(1),this.timer=new d(0),this.BF=new T(this),this.timerID=0,this.alive=!0,this.timer.subscribe((t=>{t%15==0&&this.BF.findPlayers().forEach((t=>t.addBombToPlayer()))}))}startGame(){this.timer.set(0),this.status.set(u.IN_PROGRESS),this.startTimer()}stopGame(){this.stopTimer(),setTimeout((()=>{this.status.set(u.FINISHED),[...this.BF.players.entries()].forEach((([t,e])=>{G.to(t).emit(e.alive?"victory":"defeat")}))}),500)}exitGame(){this.BF.destroy(),this.stopTimer(),this.status.set(u.NOT_STARTED),this.stage.set(1),this.timer.set(0)}startTimer(){this.timerID=setInterval((()=>{this.timer.set(this.timer.get()+1)}),1e3)}stopTimer(){clearInterval(this.timerID)}addFirstPlayer(t){this.BF.addEntity(new O({id:t,BF:this.BF,pos:n}))}addSecondPlayer(t){this.BF.addEntity(new O({id:t,BF:this.BF,pos:l}))}exportData(t){return{[a.index]:t,[a.players]:this.BF.findPlayers().map((t=>t.getExportData())),[a.soft_walls]:this.BF.exportSoftWalls(),[a.bombs]:this.BF.exportBombs(),[a.explosions]:this.BF.exportExplosions(),[a.timer]:this.timer.get()}}}const I=require("http");var N=t.n(I);const F=require("socket.io"),b=require("express");var L=t.n(b);const S=require("uuid");class g{constructor(){this.playersId=[],this.isClosed=!1,this.id=(0,S.v4)(),this.game=new B}get size(){return this.playersId.length}get isFull(){return 2===this.size}addPlayer(t){this.playersId.push(t),this.isFull&&(this.isClosed=!0)}removePlayer(t){this.playersId=this.playersId.filter((e=>e!==t)),this.game.BF.removePlayer(t)}}const D={rooms:(()=>{let t=[];const e=new Map;return{rooms:t,players:e,addPlayer:s=>{const i=t.find((t=>!t.isFull&&!t.isClosed));if(i)i.addPlayer(s),e.set(s,i),i.game.addSecondPlayer(s),i.game.startGame(),((t,s)=>{var i,o;const r=null!==(o=null===(i=e.get(t))||void 0===i?void 0:i.playersId)&&void 0!==o?o:[];G.to(r).emit("game:starting"),G.to(r).emit("state",s.game.exportData(s.playersId.findIndex((e=>e===t)))),s.game.status.set(u.IN_PROGRESS)})(s,i);else{const i=new g;i.addPlayer(s),i.game.addFirstPlayer(s),t.push(i),e.set(s,i),o=s,r=i,G.to(o).emit("game:waiting-player"),G.to(o).emit("state",r.game.exportData(r.playersId.findIndex((t=>t===o)))),r.game.status.set(u.WAITING_PLAYER)}var o,r},removePlayer:s=>{var i;const o=(t=>{var s;return null!==(s=e.get(t))&&void 0!==s?s:null})(s);var r;return null==o||o.removePlayer(s),0===(null==o?void 0:o.size)&&(r=o.id,t=t.filter((t=>t.id!==r))),e.delete(s),null!==(i=null==o?void 0:o.playersId)&&void 0!==i?i:[]}}})()};var R;!function(t){t[t.UP=2]="UP",t[t.RIGHT=3]="RIGHT",t[t.DOWN=4]="DOWN",t[t.LEFT=5]="LEFT",t[t.SPACE=6]="SPACE"}(R||(R={}));const _={connect:t=>()=>{try{D.rooms.addPlayer(t.id),G.emit("player:connected-success",t.id),console.log("~ player:connected-success",t.id)}catch(e){G.emit("player:connected-error",t.id),console.log("~ player:connected-error",t.id),console.log("~ error",e)}},socketDisconnect:t=>e=>{D.rooms.removePlayer(t.id).forEach((e=>{G.to(e).emit("player:disconnected",t.id)})),console.log("~ player:disconnected",t.id,e)},action:t=>({key:e,isKeyDown:s})=>{const i=D.rooms.players.get(t.id);if(i){const o=i.game.BF.findPlayerById(t.id);if(e!==R.SPACE)if(s)switch(e){case R.UP:null==o||o.moveOn(c.UP);break;case R.RIGHT:null==o||o.moveOn(c.RIGHT);break;case R.DOWN:null==o||o.moveOn(c.DOWN);break;case R.LEFT:null==o||o.moveOn(c.LEFT);break;default:null==o||o.moveOn(c.NONE)}else null==o||o.moveOff();else null==o||o.placeBomb()}}},A=[{name:"disconnect",controller:_.socketDisconnect},{name:"player/connect",controller:_.connect},{name:"player/disconnect",controller:_.socketDisconnect},{name:"player/action",controller:_.action}];const w=t=>{const e=new F.Server(t,{cors:{origin:"http://localhost:3000",methods:["GET"],credentials:!0}});return e.on("connection",(t=>{A.forEach((e=>{t.on(e.name,e.controller(t))}))})),setInterval((()=>{D.rooms.players.forEach(((t,s)=>{if(t.game.status.get()===u.IN_PROGRESS){const i=t.game.exportData(t.playersId.findIndex((t=>t===s)));e.to(s).emit("state",i)}}))}),20),{io:e}},M=L()(),C=N().createServer(M),{io:G}=w(C),Y=()=>{return t=void 0,e=void 0,i=function*(){C.listen(3002,(()=>{console.log("Sockets is started on localhost:",3002)}))},new((s=void 0)||(s=Promise))((function(o,r){function n(t){try{a(i.next(t))}catch(t){r(t)}}function l(t){try{a(i.throw(t))}catch(t){r(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(n,l)}a((i=i.apply(t,e||[])).next())}));var t,e,s,i};var U=exports;for(var H in e)U[H]=e[H];e.__esModule&&Object.defineProperty(U,"__esModule",{value:!0})})();